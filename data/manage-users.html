<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 RFID & Voice Assistant - Manage Users</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .user-table {
            overflow-x: auto;
        }
        
        .user-card {
            background-color: var(--white);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--card-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            font-size: 18px;
        }
        
        .user-details {
            line-height: 1.4;
        }
        
        .user-name {
            font-weight: bold;
            font-size: 16px;
        }
        
        .user-role {
            color: var(--secondary-color);
            font-size: 14px;
        }
        
        .user-uid {
            font-family: monospace;
            color: var(--dark-color);
            font-size: 12px;
        }
        
        .role-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            color: white;
            margin-left: 10px;
        }
        
        .role-admin {
            background-color: var(--primary-color);
        }
        
        .role-user {
            background-color: var(--success-color);
        }
        
        .role-guest {
            background-color: var(--warning-color);
        }
        
        .delete-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
        }
        
        .delete-btn:hover {
            background-color: #c82333;
        }
        
        .delete-btn i {
            margin-right: 5px;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-container {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .filter-dropdown {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        
        /* Media queries for responsive design */
        @media (max-width: 768px) {
            .user-card {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .actions {
                margin-top: 15px;
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="/" class="brand">ESP32 RFID & Voice Assistant</a>
            <ul class="nav-menu">
                <li><a href="/"><i class="fas fa-clipboard-list"></i> Access Log</a></li>
                <li><a href="add-user"><i class="fas fa-user-plus"></i> Add User</a></li>
                <li><a href="manage-users"><i class="fas fa-users-cog"></i> Manage Users</a></li>
                <li><a href="voice-assistant"><i class="fas fa-microphone-alt"></i> Voice Assistant</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="main-container">
        <div class="main-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><i class="fas fa-users-cog"></i> User Management</h2>
                <a href="add-user">
                    <button class="button button-success"><i class="fas fa-user-plus"></i> Add New User</button>
                </a>
            </div>
            
            <div class="filter-container">
                <input type="text" id="search-input" class="search-input" placeholder="Search by name or UID..." onkeyup="filterUsers()">
                <select id="role-filter" class="filter-dropdown" onchange="filterUsers()">
                    <option value="all">All Roles</option>
                    <option value="admin">Admin</option>
                    <option value="user">User</option>
                    <option value="guest">Guest</option>
                </select>
            </div>
            
            <div id="users-container">
                <!-- User cards will be dynamically added here -->
            </div>
            
            <div id="table-view" class="user-table" style="display: none;">
                <table id="tableData">
                    <thead>
                        <tr>
                            <th>UID</th>
                            <th>Role</th>
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data from users.txt will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <div>
                    <button class="button" id="view-toggle-btn" onclick="toggleView()">
                        <i class="fas fa-table"></i> Switch to Table View
                    </button>
                </div>
                <div>
                    <a href="get?delete=users" onclick="return confirm('Are you sure you want to delete ALL users? This cannot be undone!')">
                        <button class="button button-delete"><i class="fas fa-trash-alt"></i> Delete All Users</button>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let userData = [];
        let currentView = 'card'; // 'card' or 'table'
        
        // Toggle between card and table view
        function toggleView() {
            const cardsContainer = document.getElementById('users-container');
            const tableView = document.getElementById('table-view');
            const toggleBtn = document.getElementById('view-toggle-btn');
            
            if (currentView === 'card') {
                cardsContainer.style.display = 'none';
                tableView.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-id-card"></i> Switch to Card View';
                currentView = 'table';
            } else {
                cardsContainer.style.display = 'block';
                tableView.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-table"></i> Switch to Table View';
                currentView = 'card';
            }
        }
        
        // Filter users based on search input and role selection
        function filterUsers() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const roleFilter = document.getElementById('role-filter').value;
            
            // Filter the user data
            const filteredUsers = userData.filter(user => {
                const nameMatch = user.name.toLowerCase().includes(searchTerm);
                const uidMatch = user.uid.toLowerCase().includes(searchTerm);
                const roleMatch = roleFilter === 'all' || user.role === roleFilter;
                
                return (nameMatch || uidMatch) && roleMatch;
            });
            
            // Render the filtered users
            renderUsers(filteredUsers);
        }
        
        // Render user data in both card and table views
        function renderUsers(users) {
            // Render card view
            const cardsContainer = document.getElementById('users-container');
            cardsContainer.innerHTML = '';
            
            if (users.length === 0) {
                cardsContainer.innerHTML = '<p>No users found. <a href="add-user">Add a new user</a>.</p>';
                return;
            }
            
            users.forEach(user => {
                // Create user card
                const card = document.createElement('div');
                card.className = 'user-card';
                
                // Get initial for avatar
                const initial = user.name ? user.name.charAt(0).toUpperCase() : '?';
                
                // Role badge class
                let roleBadgeClass = 'role-user';
                if (user.role === 'admin') roleBadgeClass = 'role-admin';
                else if (user.role === 'guest') roleBadgeClass = 'role-guest';
                
                card.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar">${initial}</div>
                        <div class="user-details">
                            <div class="user-name">${user.name} <span class="role-badge ${roleBadgeClass}">${user.role}</span></div>
                            <div class="user-uid">${user.uid}</div>
                        </div>
                    </div>
                    <div class="actions">
                        <a href="get?delete-user=${user.uid}" onclick="return confirm('Are you sure you want to delete this user?')">
                            <button class="delete-btn"><i class="fas fa-trash-alt"></i> Delete</button>
                        </a>
                    </div>
                `;
                
                cardsContainer.appendChild(card);
            });
            
            // Render table view
            const tableBody = document.querySelector('#tableData tbody');
            tableBody.innerHTML = '';
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                
                // UID cell
                const tdUid = document.createElement('td');
                tdUid.textContent = user.uid;
                tr.appendChild(tdUid);
                
                // Role cell
                const tdRole = document.createElement('td');
                tdRole.textContent = user.role;
                tr.appendChild(tdRole);
                
                // Name cell
                const tdName = document.createElement('td');
                tdName.textContent = user.name;
                tr.appendChild(tdName);
                
                // Actions cell
                const tdActions = document.createElement('td');
                const deleteLink = document.createElement('a');
                deleteLink.href = `get?delete-user=${user.uid}`;
                deleteLink.innerHTML = '<button class="delete-btn"><i class="fas fa-trash-alt"></i> Delete</button>';
                deleteLink.onclick = () => confirm('Are you sure you want to delete this user?');
                tdActions.appendChild(deleteLink);
                tr.appendChild(tdActions);
                
                tableBody.appendChild(tr);
            });
        }
        
        // Load user data from the server
        async function loadUserData() {
            try {
                const response = await fetch('view-users');
                const data = await response.text();
                const rows = data.trim().split('\n').slice(1); // Skip the header line
                
                userData = rows.map(row => {
                    const columns = row.split(',');
                    return {
                        uid: columns[0],
                        role: columns[1],
                        name: columns[2]
                    };
                });
                
                renderUsers(userData);
            } catch (error) {
                console.error('Error loading user data:', error);
                document.getElementById('users-container').innerHTML = 
                    '<p>Error loading user data. Please refresh the page or try again later.</p>';
            }
        }
        
        // Initialize the page
        loadUserData();
    </script>
</body>
</html>
