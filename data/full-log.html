<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 RFID & Voice Assistant - Access Log</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background-color: var(--white);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        
        .stat-box i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .stat-label {
            color: var(--secondary-color);
            font-size: 0.9rem;
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .refresh-icon {
            cursor: pointer;
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-left: 10px;
            transition: transform 0.3s;
        }
        
        .refresh-icon:hover {
            transform: rotate(90deg);
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
        }
        
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-dot.active {
            background-color: var(--success-color);
        }
        
        .status-dot.inactive {
            background-color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="/" class="brand">ESP32 RFID & Voice Assistant</a>
            <ul class="nav-menu">
                <li><a href="/"><i class="fas fa-clipboard-list"></i> Access Log</a></li>
                <li><a href="add-user"><i class="fas fa-user-plus"></i> Add User</a></li>
                <li><a href="manage-users"><i class="fas fa-users-cog"></i> Manage Users</a></li>
                <li><a href="voice-assistant"><i class="fas fa-microphone-alt"></i> Voice Assistant</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="main-container">
        <div class="dashboard-stats">
            <div class="stat-box">
                <i class="fas fa-user-check"></i>
                <div class="stat-value" id="totalAccesses">0</div>
                <div class="stat-label">Total Accesses</div>
            </div>
            <div class="stat-box">
                <i class="fas fa-user-times"></i>
                <div class="stat-value" id="totalDenials">0</div>
                <div class="stat-label">Access Denials</div>
            </div>
            <div class="stat-box">
                <i class="fas fa-users"></i>
                <div class="stat-value" id="uniqueUsers">0</div>
                <div class="stat-label">Unique Users</div>
            </div>
            <div class="stat-box">
                <i class="fas fa-clock"></i>
                <div class="stat-value" id="lastAccess">-</div>
                <div class="stat-label">Last Access</div>
            </div>
        </div>
        
        <div class="main-section">
            <div class="action-bar">
                <h2><i class="fas fa-clipboard-list"></i> Access Log</h2>
                <div class="auto-refresh">
                    <span class="status-dot active" id="refresh-status"></span>
                    <span id="refresh-text">Auto-refresh active</span>
                    <i class="fas fa-sync refresh-icon" onclick="toggleRefresh()" title="Toggle auto-refresh"></i>
                </div>
            </div>
            
            <table id="tableData">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>UID</th>
                        <th>Role</th>
                        <th>Name</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data from log.txt will be loaded here -->
                </tbody>
            </table>
            
            <div style="text-align: right;">
                <a href="get?delete=log" onclick="return confirm('Are you sure you want to delete the log file? This action cannot be undone.')">
                    <button class="button button-delete"><i class="fas fa-trash-alt"></i> Clear Access Log</button>
                </a>
            </div>
        </div>
    </div>
    
    <script>
        let autoRefreshEnabled = true;
        let refreshInterval;
        let totalAccessCount = 0;
        let deniedAccessCount = 0;
        let uniqueUsersSet = new Set();
        
        // Toggle auto-refresh
        function toggleRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const statusDot = document.getElementById('refresh-status');
            const statusText = document.getElementById('refresh-text');
            
            if (autoRefreshEnabled) {
                statusDot.className = 'status-dot active';
                statusText.textContent = 'Auto-refresh active';
                refreshInterval = setInterval(loadTableData, 2000);
            } else {
                statusDot.className = 'status-dot inactive';
                statusText.textContent = 'Auto-refresh paused';
                clearInterval(refreshInterval);
            }
        }
        
        // Load table data and update statistics
        async function loadTableData() {
            try {
                const response = await fetch('view-log');
                const data = await response.text();
                const rows = data.trim().split('\n').slice(1); // Skip the header line

                const tableBody = document.querySelector('#tableData tbody');
                // Clear existing table data before adding new rows
                tableBody.innerHTML = '';
                
                // Reset counters for statistics
                totalAccessCount = rows.length;
                deniedAccessCount = 0;
                uniqueUsersSet.clear();
                
                rows.forEach(row => {
                    const columns = row.split(',');
                    
                    // Extract data for statistics
                    const role = columns[3] ? columns[3].trim() : '';
                    const uid = columns[2] ? columns[2].trim() : '';
                    const name = columns[4] ? columns[4].trim() : '';
                    
                    if (role === 'unknown') {
                        deniedAccessCount++;
                    }
                    
                    if (name && name !== 'unknown' && name !== '') {
                        uniqueUsersSet.add(name);
                    }
                    
                    // Create table row
                    const tr = document.createElement('tr');
                    
                    // Apply different styles based on role
                    if (role === 'unknown') {
                        tr.style.color = 'var(--danger-color)';
                    } else if (role === 'admin') {
                        tr.style.fontWeight = 'bold';
                    }
                    
                    columns.forEach((column, index) => {
                        const td = document.createElement('td');
                        td.textContent = column;
                        tr.appendChild(td);
                    });
                    
                    tableBody.appendChild(tr);
                });
                
                // Update statistics
                document.getElementById('totalAccesses').textContent = totalAccessCount;
                document.getElementById('totalDenials').textContent = deniedAccessCount;
                document.getElementById('uniqueUsers').textContent = uniqueUsersSet.size;
                
                // Update last access time
                if (rows.length > 0) {
                    const lastRow = rows[rows.length - 1].split(',');
                    const lastDate = lastRow[0];
                    const lastTime = lastRow[1];
                    document.getElementById('lastAccess').textContent = `${lastTime}`;
                }
                
            } catch (error) {
                console.error('Error loading log data:', error);
            }
        }

        // Initial load
        loadTableData();

        // Set up auto-refresh interval
        refreshInterval = setInterval(loadTableData, 2000);
    </script>
</body>
</html>
